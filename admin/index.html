<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPSsign2 Admin - Orono Public Schools</title>
    <link rel="stylesheet" href="/admin/admin.css">
    <link rel="stylesheet" href="/shared-styles.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo-link">
                <div class="logo-section">
                    <img src="/assets/OPSsign-Torch.png" alt="OPSsign2 Logo" class="admin-logo">
                    <div>
                        <h1>OPSsign2 Admin</h1>
                        <p>Orono Public Schools</p>
                    </div>
                </div>
            </a>
            <div class="user-section">
                <div class="user-info">
                    <img id="userPhoto" src="" alt="User Photo" class="user-photo">
                    <div class="user-details">
                        <span id="userName"></span>
                        <span id="userEmail" class="user-email"></span>
                        <span id="userPermission"></span>
                    </div>
                </div>
                <a href="/" class="btn-nav">‚Üê Homepage</a>
            </div>
        </div>
    </header>

    <main class="main-content">
        <section class="overview-section">
            <div class="stats-grid">
                <div class="card stat-card">
                    <h3>Total Devices</h3>
                    <div class="stat-number" id="totalDevices">-</div>
                </div>
                <div class="card stat-card">
                    <h3>Online</h3>
                    <div class="stat-number online" id="onlineDevices">-</div>
                </div>
                <div class="card stat-card">
                    <h3>SSE</h3>
                    <div class="stat-number" id="sseConnected">-</div>
                </div>
                <div class="card stat-card">
                    <h3>Buildings</h3>
                    <div class="stat-number" id="totalBuildings">-</div>
                </div>
                <!-- This card will be hidden by default and shown only for district admins -->
                <div class="card stat-card" id="serviceInfoCard" style="display: none;">
                    <h3>Service Account</h3>
                    <div class="service-info-content">
                        <p>Share Google Slides/Sheets with this email:</p>
                        <strong id="serviceAccountEmail" class="service-account-email">Loading...</strong>
                        <button id="copyServiceEmailBtn" class="btn btn-secondary btn-copy">Copy</button>
                    </div>
                </div>
            </div>
        </section>

        <section class="devices-section">
            <div class="section-header">
                <h2>Device Management</h2>
                <div class="section-actions">
                    <div class="filter-container" id="buildingFilter" style="display: none;">
                        <label for="buildingSelect">Filter by Building:</label>
                        <select id="buildingSelect">
                            <option value="">All Buildings</option>
                        </select>
                    </div>
                    <button id="pushRefreshBtn" class="btn btn-secondary">
                        üì° Push Refresh to All
                    </button>
                    <button id="checkSseBtn" class="btn btn-info">
                        üìä Check SSE Status
                    </button>
                    <button id="addDeviceBtn" class="btn btn-primary" >
                        <span>+</span> Add Device
                    </button>
                </div>
            </div>

            <div class="devices-grid" id="devicesGrid">
                <!-- Devices will be populated by JavaScript -->
                <div class="loading" id="devicesLoading">Loading devices...</div>
            </div>
        </section>

        <!-- NEW: Alert Management Section -->
        <section class="alerts-section">
            <div class="section-header">
                <h2>Alert Management</h2>
                <div class="alert-stats">
                    <span class="stat-item">
                        <span class="stat-label">Total:</span>
                        <span class="stat-number" id="totalAlerts">0</span>
                    </span>
                    <span class="stat-item">
                        <span class="stat-label">Active:</span>
                        <span class="stat-number active" id="activeAlerts">0</span>
                    </span>
                    <span class="stat-item">
                        <span class="stat-label">High Priority:</span>
                        <span class="stat-number priority-high" id="highPriorityAlerts">0</span>
                    </span>
                </div>
                <div class="section-actions">
                    <button id="addAlertBtn" class="btn btn-primary"><span>+</span> Create Alert</button>
                </div>
            </div>

            <!-- Alerts Table -->
            <div class="alerts-table-container">
                <div class="alerts-grid" id="alertsGrid">
                    <div class="loading" id="alertsLoading">Loading alerts...</div>
                </div>
            </div>
        </section>
    </main>

    <!-- Updated Add/Edit Device Modal -->
    <div id="deviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="deviceModalTitle">Add New Device</h3>
                <span id="closeDeviceModalBtn" class="modal-close">&times;</span>
            </div>
            <form id="deviceForm">
                <!-- Add hidden field for edit mode -->
                <input type="hidden" id="editDeviceId" name="editDeviceId">
    
                <div class="form-group">
                    <label for="deviceId">Device ID</label>
                    <input type="text" id="deviceId" name="deviceId" required placeholder="e.g., lobby-1, cafe-2">
                </div>
                <div class="form-group">
                    <label for="name">Display Name</label>
                    <input type="text" id="name" name="name" required placeholder="e.g., Main Lobby TV">
                </div>
                <div class="form-group">
                    <label for="location">Location</label>
                    <input type="text" id="location" name="location" required placeholder="e.g., Main Lobby, Cafeteria">
                </div>
                <div class="form-group">
                    <label for="ipAddress">IP Address (for Ping Status)</label>
                    <input type="text" id="ipAddress" name="ipAddress" placeholder="e.g., 10.1.1.100"
                        pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" title="Enter a valid IP address">
                </div>
                <div class="form-group">
                    <label for="coordinates">Coordinates (for Weather)</label>
                    <input type="text" id="coordinates" name="coordinates" placeholder="e.g., 44.9778,-93.2650"
                        pattern="^-?\d{1,3}\.\d+,-?\d{1,3}\.\d+$" title="Enter as 'latitude,longitude'">
                </div>
                <div class="form-group">
                    <label for="building">Building</label>
                    <select id="building" name="building" required>
                        <option value="">Select Building</option>
                        <option value="SE">SE - Schumann Elementary</option>
                        <option value="IS">IS - Intermediate School</option>
                        <option value="MS">MS - Middle School</option>
                        <option value="HS">HS - High School</option>
                        <option value="DC">DC - Discovery Center</option>
                        <option value="DO">DO - District Office</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="template">Template</label>
                    <select id="template" name="template">
                        <option value="fullscreen">Fullscreen (Slides)</option>
                        <option value="sidebar-menu">Sidebar:M (Slides + Menu)</option>
                        <option value="sidebar-calendar">Sidebar:C (Slides + Calendar)</option>
                        <option value="sidebar-rotate">Sidebar:R (Slides + Menu/Cal Rotate)</option>
                        <option value="panels">Panels (Slides + Calendar + Menu)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="presentationLink">Google Slides Link (Optional)</label>
                    <input type="url" id="presentationLink" name="presentationLink" 
                           placeholder="Paste the full Google Slides sharing link here">
                    <div id="urlValidation" class="validation-feedback"></div>
                </div>
                <div class="form-group">
                    <label for="slideId">Google Slides ID</label>
                    <input type="text" id="slideId" name="slideId" 
                           placeholder="Extracted from link above, or enter manually">
                </div>

                <div class="form-group">
                    <label for="googleCalendarUrl">Google Calendar URL (for templates with a calendar module)</label>
                    <input type="url" id="googleCalendarUrl" name="googleCalendarUrl" placeholder="Paste the public calendar embed URL">
                    <small>This is a per-device setting. Leave blank if this display's template does not use a calendar.</small>
                </div>

                <div class="form-group">
                    <label for="notes">Notes</label>
                    <textarea id="notes" name="notes" rows="3" placeholder="Internal notes about this device..."></textarea>
                </div>
                <div class="form-group form-group-checkbox">
                    <label for="active" class="checkbox-label">
                        <input type="checkbox" id="active" name="active" checked>
                        <span class="checkmark"></span>
                        Device is Active
                    </label>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelDeviceBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveDeviceBtn">Add Device</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Alert Add/Edit Modal -->
    <div id="alertModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="alertModalTitle">Create New Alert</h3>
                <span id="closeAlertModalBtn" class="modal-close">&times;</span>
            </div>
            <form id="alertForm">
                <div class="form-group">
                    <label for="alertName">Alert Name</label>
                    <input type="text" id="alertName" name="name" required placeholder="e.g., Weather Delay - 2 Hour Late Start">
                </div>
                <div class="form-group">
                    <label for="alertType">Alert Type</label>
                    <select id="alertType" name="type" required>
                        <option value="srp">Standard Response Protocol</option>
                        <option value="custom">Custom Message</option>
                        <option value="slide">Google Slide</option>
                    </select>
                </div>

                <!-- Fields for SRP -->
                <div id="alert-fields-srp" class="alert-fields">
                    <div class="form-group">
                        <label for="srpAction">Action</label>
                        <select id="srpAction" name="srpAction">
                            <option value="Hold">Hold - "In Your Room or Area"</option>
                            <option value="Secure">Secure - "Get Inside. Lock Outside Doors."</option>
                            <option value="Lockdown">Lockdown - "Locks, Lights, Out of Sight"</option>
                            <option value="Evacuate">Evacuate - "To a Location"</option>
                            <option value="Shelter">Shelter - "For a Hazard"</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="srpText">Additional Instructions (Optional)</label>
                        <textarea id="srpText" name="text" rows="3" placeholder="e.g., Evacuate to the football field. This text will appear below the main SRP message."></textarea>
                    </div>
                </div>

                <!-- Fields for Custom Message -->
                <div id="alert-fields-custom" class="alert-fields" style="display: none;">
                    <div class="form-group">
                        <label for="alertTitle">Title</label>
                        <input type="text" id="alertTitle" name="title" placeholder="e.g., Important Announcement">
                    </div>
                    <div class="form-group">
                        <label for="alertText">Message Body</label>
                        <textarea id="alertText" name="text" rows="4" placeholder="Enter the full alert message here."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="alertIcon">Icon</label>
                        <select id="alertIcon" name="icon">
                            <option value="none">No Icon</option>
                            <option value="exclamation-triangle">‚ö†Ô∏è Exclamation Triangle</option>
                            <option value="info-circle">‚ÑπÔ∏è Info Circle</option>
                            <option value="check-circle">‚úÖ Check Circle</option>
                            <option value="times-circle">‚ùå Canceled/Closed</option>
                        </select>
                    </div>
                </div>

                <!-- Fields for Google Slide -->
                <div id="alert-fields-slide" class="alert-fields" style="display: none;">
                    <div class="form-group">
                        <label for="alertSlideId">Google Slides ID</label>
                        <input type="text" id="alertSlideId" name="slideId" placeholder="Google Slides ID for this alert">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="priority">Priority Level</label>
                        <select id="priority" name="priority" required>
                            <option value="Low">Low Priority</option>
                            <option value="Medium" selected>Medium Priority</option>
                            <option value="High">High Priority</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="expires">Expiration (Optional)</label>
                        <input type="datetime-local" id="expires" name="expires">
                    </div>
                </div>
                <div class="form-group building-selection">
                    <label>Target Buildings</label>
                    <div class="quick-select-buttons">
                        <button type="button" id="selectAllBtn">All</button>
                        <button type="button" id="selectElementaryBtn">Elementary</button>
                        <button type="button" id="selectSecondaryBtn">Secondary</button>
                    </div>
                    <div class="building-checkboxes" id="buildingSelection">
                        <!-- Checkboxes will be populated by JavaScript -->
                    </div>
                </div>
                <div class="form-group form-group-checkbox">
                    <label for="alertActive" class="checkbox-label">
                        <input type="checkbox" id="alertActive" name="active" checked>
                        <span class="checkmark"></span>
                        Alert is Active
                    </label>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelAlertBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveAlertBtn">Create Alert</button>
                </div>
            </form>
        </div>
    </div>
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <p>Loading Admin Interface...</p>
    </div>
    <div class="error-message" id="errorMessage" style="display: none;">
        <div class="error-icon">‚ö†Ô∏è</div>
        <div class="error-content">
            <h3>Error</h3>
            <p id="errorText">An error occurred.</p>
            <button onclick="window.location.reload()" class="retry-btn">Retry</button>
        </div>
    </div>
    <script src="/admin/admin.js"></script>
</body>
</html>